# CEQP 插件（TCP_UDP 服务端）

基于 Cheat Engine 的插件，实现 CEQP 协议的服务端。通过 TCP/UDP 与外部客户端通信，支持模块基址查询、内存读写、指针链读取/写入，并返回统一的错误码与消息。该插件作为 CE 的扩展加载，位数需与 CE 保持一致（x64 或 x86）。

---

## 架构与设计原则

- **加载与生命周期**：
  - CE 启动后加载插件（`tcp_udp_plugin.dll`）。
  - 插件创建监听套接字（默认 `TCP:9178`），可支持 UDP 心跳。
  - 接受客户端连接后，循环处理帧请求，按类型执行对应操作。

- **线程与并发**：
  - 每个连接独立处理；关键内存操作在 CE 主进程上下文中执行。
  - 使用轻量锁保护模块列表与全局状态，避免竞争条件。

- **错误与健壮性**：
  - 接口统一返回 `ERROR_RESP`，包含 `ERRCODE(u32)` 与 `ERRMSG(string)`。
  - 非法地址、不可读/写页面、无模块、访问越界等均有明确错误码。

---

## CEQP 协议（服务端实现）

- **帧结构**：
  - 固定帧头（含版本、长度、校验），负载为 TLV 列表；小端编码。
  - 常用 TLV：
    - `ADDR(u64)`：目标地址或解析后的基址。
    - `LEN(u32)`：长度；用于读/写内存。
    - `MODNAME(string)`：模块名；用于查询模块基址。
    - `OFFSET(s64)`：单个偏移；模块基址 + 偏移时使用。
    - `OFFSETS(s64[])`：偏移链；指针链遍历使用。
    - `DTYPE(string)`：数据类型描述（如 `ce noderef ptr64`）。
    - `DATA(bytes)`：写入数据或读取结果。
    - `ERRCODE(u32)`、`ERRMSG(string)`：错误应答。

- **指令类型**（示例）：
  - `PING`：心跳检测；快速返回，用于连接保活。
  - `READ_MEM`：按 `ADDR/LEN` 读取内存。
  - `WRITE_MEM`：按 `ADDR/DATA` 写入内存。
  - `GET_MODULE_BASE`：返回 `MODNAME` 对应的基址。
  - `READ_PTR_CHAIN`：按 `ADDR/DTYPE/OFFSETS` 遍历并返回最终地址与数据。
  - `WRITE_PTR_CHAIN`：按 `ADDR/DTYPE/OFFSETS/DATA` 遍历并写入最终地址。

---

## 地址与偏移的服务端约束

- 模块名与偏移由客户端解析与校验后再发送；服务端侧假定：
  - `MODNAME` 无引号且合法（若客户端容错去引号后仍非法，将在客户端报错）。
  - `OFFSET/ OFFSETS` 为已转换好的有符号 64 位整数；偏移链支持负数。
  - `ADDR` 为有效的进程地址（指针大小与 CE 目标进程一致）。

- 服务端会对地址页属性进行检查：不可访问时返回 `ERRCODE=E_MEM_PROTECT`。

---

## 指针链实现细节

- 遍历逻辑：
  1. 从 `ADDR` 或 `模块基址+偏移` 计算初始地址。
  2. 对每个 `OFFSET`：读取当前地址处指针（按 `ptr32/ptr64`），相加得到下一级地址。
  3. 最终地址处按 `DTYPE` 读取或写入数据。

- `DTYPE` 示例：
  - `ce noderef ptr64 u32`：CE 语义、节点引用、64 位指针、最终读写 `u32`。
  - 支持 `u8/u16/u32/u64/i8/i16/i32/i64/float/double` 与原始字节序列。

---

## 构建与部署

- 使用 VS 构建 `Release|x64`（或与 CE 配套的位数）。
- 将生成的 `tcp_udp_plugin.dll` 放入 CE 插件目录或通过 `run.lua` 脚本加载。
- 启动 CE，确保插件成功加载并开始监听。

示例（Lua 伪代码）：

```lua
local host = "127.0.0.1"
local port = 9178
-- 在 CE 侧连接并处理传入请求（插件内部完成），此处仅演示配置
```

---

## 性能与安全

- 帧处理为同步串行；可通过增加工作线程提升并发，但需权衡 CE API 的线程安全。
- 数据包校验与长度限制防止异常负载（默认单帧不超过 1MB）。
- 禁止跨进程写入非目标进程的地址空间；所有操作在当前附加进程上下文内执行。

---

## 兼容性说明

- 适配 CE 7.x；插件位数需与 CE 一致。
- Windows 10/11 测试通过；理论上兼容更早版本（需禁用部分 API）。

---

## 常见问题

- 插件未监听：确认 DLL 已加载、端口未被占用、防火墙未阻止。
- `GET_MODULE_BASE` 返回空：模块名不匹配或进程未加载该模块。
- 指针链遍历失败：指针大小与进程不匹配，或中间节点不可读。

---

## 许可证

MIT；请遵守相关法律法规与平台条款。

